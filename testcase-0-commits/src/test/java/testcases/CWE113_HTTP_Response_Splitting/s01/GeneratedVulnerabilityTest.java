package testcases.CWE113_HTTP_Response_Splitting.s01;

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpServletResponseWrapper;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

class CWE113_HTTP_Response_Splitting__Environment_addCookieServlet_01Test {

    private static final String ENV_VARIABLE_NAME = "ADD";
    private String originalEnvValue;

    @BeforeEach
    void setUp() {
        // Save the original environment variable value
        originalEnvValue = System.getenv(ENV_VARIABLE_NAME);
    }

    @AfterEach
    void tearDown() {
        // Restore the original environment variable value
        if (originalEnvValue != null) {
            System.setProperty(ENV_VARIABLE_NAME, originalEnvValue);
        } else {
            System.clearProperty(ENV_VARIABLE_NAME);
        }
    }

    @Test
    void testBad() throws Throwable {
        // Set a malicious environment variable value
        System.setProperty(ENV_VARIABLE_NAME, "en-US\r\nSet-Cookie: sessionId=12345");

        // Create a servlet instance
        CWE113_HTTP_Response_Splitting__Environment_addCookieServlet_01 servlet = new CWE113_HTTP_Response_Splitting__Environment_addCookieServlet_01();

        // Create mock request and response
        HttpServletRequest request = new HttpServletRequestStub();
        HttpServletResponseMock response = new HttpServletResponseMock();

        // Call the bad method
        servlet.bad(request, response);

        // Check if the response contains the malicious cookie
        List<Cookie> cookies = response.getCookies();
        assertEquals(1, cookies.size(), "Expected one cookie to be added");
        assertEquals("lang", cookies.get(0).getName(), "Expected cookie name to be 'lang'");
        assertEquals("en-US\r\nSet-Cookie: sessionId=12345", cookies.get(0).getValue(), "Cookie value should contain the malicious input");
    }

    // Stub class for HttpServletRequest
    private static class HttpServletRequestStub extends HttpServletRequestWrapper {
        public HttpServletRequestStub() {
            super(null);
        }
    }

    // Mock class for HttpServletResponse
    private static class HttpServletResponseMock extends HttpServletResponseWrapper {
        private final List<Cookie> cookies = new ArrayList<>();

        public HttpServletResponseMock() {
            super(null);
        }

        @Override
        public void addCookie(Cookie cookie) {
            cookies.add(cookie);
        }

        public List<Cookie> getCookies() {
            return cookies;
        }
    }
}