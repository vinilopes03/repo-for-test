package testcases.CWE113_HTTP_Response_Splitting.s01;

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpServletResponseWrapper;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

class CWE113_HTTP_Response_Splitting__Environment_addCookieServlet_02Test {

    private static final String ENV_VARIABLE_NAME = "ADD";
    private String originalEnvValue;

    @BeforeEach
    void setUp() {
        // Save the original environment variable value
        originalEnvValue = System.getenv(ENV_VARIABLE_NAME);
    }

    @AfterEach
    void tearDown() {
        // Restore the original environment variable value
        if (originalEnvValue != null) {
            System.setProperty(ENV_VARIABLE_NAME, originalEnvValue);
        } else {
            System.clearProperty(ENV_VARIABLE_NAME);
        }
    }

    @Test
    void testBad() throws Throwable {
        // Set a malicious value in the environment variable
        System.setProperty(ENV_VARIABLE_NAME, "en-US\r\nSet-Cookie: sessionId=12345");

        // Create a mock request and response
        HttpServletRequest request = new MockHttpServletRequest();
        MockHttpServletResponse response = new MockHttpServletResponse();

        // Instantiate the class and call the bad method
        CWE113_HTTP_Response_Splitting__Environment_addCookieServlet_02 servlet =
                new CWE113_HTTP_Response_Splitting__Environment_addCookieServlet_02();
        servlet.bad(request, response);

        // Check if the response contains the malicious cookie
        List<Cookie> cookies = response.getCookies();
        assertEquals(1, cookies.size(), "Expected one cookie to be added");
        assertEquals("lang", cookies.get(0).getName(), "Cookie name should be 'lang'");
        assertEquals("en-US", cookies.get(0).getValue(), "Cookie value should be 'en-US'");
    }

    // Mock HttpServletRequest
    private static class MockHttpServletRequest implements HttpServletRequest {
        // Implement only the methods you need for the test
        // All other methods can throw UnsupportedOperationException
        @Override
        public String getAuthType() {
            throw new UnsupportedOperationException();
        }

        // Add other methods as needed...
    }

    // Mock HttpServletResponse
    private static class MockHttpServletResponse extends HttpServletResponseWrapper {
        private final List<Cookie> cookies = new ArrayList<>();

        public MockHttpServletResponse() {
            super(new HttpServletResponse() {
                @Override
                public void addCookie(Cookie cookie) {
                    // Do nothing
                }

                // Implement other methods as needed...
            });
        }

        @Override
        public void addCookie(Cookie cookie) {
            cookies.add(cookie);
        }

        public List<Cookie> getCookies() {
            return cookies;
        }

        // Implement other methods as needed...
    }
}